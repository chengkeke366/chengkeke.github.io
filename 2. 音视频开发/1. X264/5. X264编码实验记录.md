## 一：AnnexB与AVCC格式的选择

### AnnexB格式

**[start code]NALU | [start code] NALU |...**
这种格式比较常见，也就是我们熟悉的每个帧前面都有0x00 00 00 01或者0x00 00 01作为起始码。.h264文件就是采用的这种格式，每个帧前面都要有个起始码。SPS PPS等也作为一类NALU存储在这个码流中，一般在码流最前面。也就是说这种格式包含VCL 和 非VCL 类型的NALU。

### AVCC格式

**([extradata]) | ([length] NALU) | ([length] NALU) | ...**
这种模式也叫AVC1格式，没有起始码，每个帧最前面几个字节（通常4字节）是帧长度。这里的NALU一般没有SPS PPS等参数信息，参数信息属于额外数据extradata存在其他地方。比如ffmpeg中解析mp4文件后sps pps存在streams[index]->codecpar->extradata中。也就是说这种码流通常只包含VCL类型NALU。在一路采用 avcC 打包的 H.264 流之中，我们首先看到的将是一段被称之为 extradata 的数据，这段数据定义了这个 H.264 流的基本属性数据，当然，也包含了 SPS 和 PPS 数据。

我们来看一下 extradata 数据格式，我们注意一下这个值 NALULengthSizeMinusOne，通过将这个值加 1 ，我们就得出了后续每个 NALU 前面前缀（也就是表示长度的整数）的字节数。例如，这个 NALULengthSizeMinusOne 是 3，那么每个 NALU 前面前缀的长度就是 4 个字节。我们在读取后续数据时，可以先读 4 个字节，然后把这四个字节转成整数，就是这个 NALU 的长度了，注意，这个长度并不包含起始的4个字节，是单纯 NALU 的长度

```c++
bits      
8   version ( always 0x01 )  
8   avc profile ( sps[0][1] )  
8   avc compatibility ( sps[0][2] )  
8   avc level ( sps[0][3] )  
6   reserved ( all bits on )  
2   NALULengthSizeMinusOne    // 这个值是（前缀长度-1）
3   reserved ( all bits on )  
5   number of SPS NALUs (usually 1)  
        repeated once per SPS:  
16  SPS size  
        variable SPS NALU data  
8   number of PPS NALUs (usually 1)  
        repeated once per PPS  
16  PPS size  
        variable PPS NALU data
```



**问题1： x264编码默认生成是AVCC格式还是annexb格式？ **

* 经过试验，默认为annexb格式（即`b_annexb`默认为true）

* x264编码参数 `b_annexb` 为true打开Annexb格式的码流，即在每个NAL前加入起始码，

* x264编码参数 `b_annexb` 为false，则关闭Annexb格式的码流，将起始码变为该NAL部分的长度。
* **播放器只能播放annexb格式的码流，关闭b_annexb且确保sps pps有写入，使用ffplay与vlc播放器均无法播放**

如下是annexb与avcc格式的对比。

<img src="image/5.%20X264%E7%BC%96%E7%A0%81%E5%AE%9E%E9%AA%8C%E8%AE%B0%E5%BD%95/20190403171716287.png" alt="img" style="zoom: 80%;" />

代码：

<img src="image/5.%20X264%E7%BC%96%E7%A0%81%E5%AE%9E%E9%AA%8C%E8%AE%B0%E5%BD%95/20190404093442644.png" alt="img" style="zoom:67%;" />





### FFmpeg使用x264默认编码出来的是什么码流？

* ffmpeg使用x264编码后的码流，默认I帧前都有SPS和PPS

![image-20220815064540337](image/5.%20X264%E7%BC%96%E7%A0%81%E5%AE%9E%E9%AA%8C%E8%AE%B0%E5%BD%95/image-20220815064540337.png)